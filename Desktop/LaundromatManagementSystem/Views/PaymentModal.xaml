<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:LaundromatManagementSystem.ViewModels"
             xmlns:converters="clr-namespace:LaundromatManagementSystem.Converters"
             x:Class="LaundromatManagementSystem.Views.PaymentModal"
             x:DataType="vm:PaymentModalViewModel"
             WidthRequest="700">

        <ScrollView>
                <Border Stroke="{Binding BorderColor}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 16"
                        BackgroundColor="{Binding BackgroundColor}"
                        Padding="32">

                        <Grid RowDefinitions="Auto, Auto, *, Auto"
                              RowSpacing="24"
                              MinimumHeightRequest="500">

                                <!-- Header -->
                                <Grid Grid.Row="0"
                                      RowDefinitions="Auto, Auto"
                                      RowSpacing="8"
                                      Padding="0,0,0,16">

                                        <!-- Title and Close Button -->
                                        <Grid ColumnDefinitions="*, Auto">
                                                <Label Grid.Column="0"
                                                       Text="{Binding Title}"
                                                       FontSize="28"
                                                       FontAttributes="Bold"
                                                       TextColor="{Binding TitleColor}"/>

                                                <!-- Close Button -->
                                                <Border Grid.Column="1"
                                                        BackgroundColor="Transparent"
                                                        WidthRequest="44"
                                                        HeightRequest="44"
                                                        StrokeThickness="0"
                                                        StrokeShape="RoundRectangle 22">
                                                        <Label Text="âœ•"
                                                               FontSize="24"
                                                               FontAttributes="Bold"
                                                               TextColor="{Binding TitleColor}"
                                                               HorizontalOptions="Center"
                                                               VerticalOptions="Center"/>

                                                        <Border.GestureRecognizers>
                                                                <TapGestureRecognizer Command="{Binding ClosePaymentModalCommand}"/>
                                                        </Border.GestureRecognizers>
                                                </Border>
                                        </Grid>

                                        <!-- Transaction Info -->
                                        <Label Grid.Row="1"
                                               FontSize="16"
                                               Margin="0,0,0,12">
                                                <Label.FormattedText>
                                                        <FormattedString>
                                                                <Span Text="{Binding TransactionLabel}"
                                                                      TextColor="{Binding SubtitleColor}"/>
                                                                <Span Text=" "/>
                                                                <Span Text="{Binding TransactionId}"
                                                                      FontAttributes="Bold"
                                                                      TextColor="#F59E0B"/>
                                                                <Span Text=" | "
                                                                      TextColor="{Binding SubtitleColor}"/>
                                                                <Span Text="{Binding TotalLabel}"
                                                                      TextColor="{Binding SubtitleColor}"/>
                                                                <Span Text=" "/>
                                                                <Span Text="{Binding Total, StringFormat='{0:N0} RWF'}"
                                                                      FontAttributes="Bold"
                                                                      TextColor="#F59E0B"/>
                                                        </FormattedString>
                                                </Label.FormattedText>
                                        </Label>

                                        <!-- Separator -->
                                        <BoxView Grid.RowSpan="2"
                                                 Grid.ColumnSpan="2"
                                                 Color="{Binding BorderColor}"
                                                 HeightRequest="2"
                                                 VerticalOptions="End"
                                                 HorizontalOptions="Fill"/>

                                </Grid>

                                <!-- Step 1: Customer Information Section -->
                                <VerticalStackLayout Grid.Row="1"
                                                     Spacing="16"
                                                     IsVisible="{Binding ShowPaymentMethods, Converter={StaticResource InvertBooleanConverter}}">

                                        <!-- Header -->
                                        <Label Text="{Binding CustomerInfoTitle}"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="{Binding TitleColor}"/>

                                        <!-- Phone Number Input -->
                                        <VerticalStackLayout Spacing="8">
                                                <Label Text="{Binding CustomerLabel}"
                                                       FontSize="16"
                                                       FontAttributes="Bold"
                                                       TextColor="{Binding TextColor}"/>

                                                <Entry Text="{Binding Customer}"
                                                       Placeholder="+250 788 123 456"
                                                       FontSize="16"
                                                       HeightRequest="56"
                                                       BackgroundColor="{Binding InputBackgroundColor}"
                                                       TextColor="{Binding TextColor}"
                                                       PlaceholderColor="{Binding PlaceholderColor}"
                                                       ClearButtonVisibility="WhileEditing"
                                                       Keyboard="Telephone"/>
                                        </VerticalStackLayout>

                                        <!-- OR Divider -->
                                        <Grid ColumnDefinitions="*, Auto, *"
                                              VerticalOptions="Center">
                                                <BoxView Grid.Column="0"
                                                         Color="{Binding BorderColor}"
                                                         HeightRequest="1"
                                                         VerticalOptions="Center"/>
                                                <Label Grid.Column="1"
                                                       Text="{Binding OrLabel}"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       TextColor="{Binding SubtitleColor}"
                                                       Margin="12,0"
                                                       HorizontalOptions="Center"/>
                                                <BoxView Grid.Column="2"
                                                         Color="{Binding BorderColor}"
                                                         HeightRequest="1"
                                                         VerticalOptions="Center"/>
                                        </Grid>

                                        <!-- TIN Number Input -->
                                        <VerticalStackLayout Spacing="8">
                                                <Label Text="{Binding TinLabel}"
                                                       FontSize="16"
                                                       FontAttributes="Bold"
                                                       TextColor="{Binding TextColor}"/>

                                                <Grid ColumnDefinitions="*, Auto"
                                                      ColumnSpacing="12">
                                                        <Entry Grid.Column="0"
                                                               Text="{Binding TinNumber}"
                                                               Placeholder="123456789"
                                                               FontSize="16"
                                                               HeightRequest="56"
                                                               BackgroundColor="{Binding InputBackgroundColor}"
                                                               TextColor="{Binding TextColor}"
                                                               PlaceholderColor="{Binding PlaceholderColor}"
                                                               ClearButtonVisibility="WhileEditing"
                                                               Keyboard="Numeric"/>

                                                        <Button Grid.Column="1"
                                                                Text="{Binding ClearTinButtonText}"
                                                                BackgroundColor="Transparent"
                                                                TextColor="#EF4444"
                                                                FontSize="14"
                                                                HeightRequest="56"
                                                                Command="{Binding ClearCustomerInfoCommand}"/>
                                                </Grid>
                                        </VerticalStackLayout>

                                        <!-- Purchase Code Input (Shows when TIN is entered) -->
                                        <VerticalStackLayout Spacing="8"
                                                             IsVisible="{Binding ShowTinPurchaseCode}">
                                                <Label Text="{Binding PurchaseCodeLabel}"
                                                       FontSize="16"
                                                       FontAttributes="Bold"
                                                       TextColor="{Binding TextColor}"/>

                                                <Entry Text="{Binding PurchaseCode}"
                                                       Placeholder="Required for TIN transactions"
                                                       FontSize="16"
                                                       HeightRequest="56"
                                                       BackgroundColor="{Binding InputBackgroundColor}"
                                                       TextColor="{Binding TextColor}"
                                                       PlaceholderColor="{Binding PlaceholderColor}"
                                                       ClearButtonVisibility="WhileEditing"
                                                       IsPassword="True"/>

                                                <Label Text="{Binding PurchaseCodeAlert}"
                                                       FontSize="12"
                                                       TextColor="#EF4444"/>
                                        </VerticalStackLayout>

                                        <!-- Validation Message -->
                                        <Border IsVisible="{Binding IsCustomerInfoValid, Converter={StaticResource InvertBooleanConverter}}"
                                                Stroke="#EF4444"
                                                StrokeThickness="1"
                                                StrokeShape="RoundRectangle 8"
                                                BackgroundColor="#FEE2E2"
                                                Padding="16,12">
                                                <HorizontalStackLayout Spacing="12">
                                                        <Label Text="âš "
                                                               FontSize="16"
                                                               TextColor="#EF4444"/>
                                                        <Label Text="{Binding CustomerValidationMessage}"
                                                               FontSize="14"
                                                               TextColor="#DC2626"/>
                                                </HorizontalStackLayout>
                                        </Border>

                                        <!-- Success Message -->
                                        <Border IsVisible="{Binding IsCustomerInfoValid}"
                                                Stroke="#10B981"
                                                StrokeThickness="1"
                                                StrokeShape="RoundRectangle 8"
                                                BackgroundColor="#D1FAE5"
                                                Padding="16,12">
                                                <HorizontalStackLayout Spacing="12">
                                                        <Label Text="âœ“"
                                                               FontSize="16"
                                                               TextColor="#10B981"/>
                                                        <Label Text="{Binding CustomerValidationSuccessMessage}"
                                                               FontSize="14"
                                                               TextColor="#065F46"/>
                                                </HorizontalStackLayout>
                                        </Border>

                                        <!-- Continue Button -->
                                        <Button Text="{Binding ContinueToPaymentText}"
                                                BackgroundColor="#3B82F6"
                                                TextColor="White"
                                                FontSize="16"
                                                FontAttributes="Bold"
                                                IsEnabled="{Binding IsCustomerInfoValid}"
                                                Command="{Binding ContinueToPaymentCommand}"
                                                Margin="0,16,0,0"/>
                                </VerticalStackLayout>

                                <!-- Step 2: Payment Method Selection -->
                                <VerticalStackLayout Grid.Row="1"
                                                     Spacing="24"
                                                     IsVisible="{Binding ShowPaymentMethods}">

                                        <!-- Back to Customer Info Button -->
                                        <Button Text="{Binding BackToCustomerInfoText}"
                                                BackgroundColor="Transparent"
                                                TextColor="#3B82F6"
                                                FontSize="14"
                                                HorizontalOptions="Start"
                                                HeightRequest="40"
                                                Command="{Binding GoBackToCustomerInfoCommand}"/>

                                        <!-- Selected Customer Info Summary -->
                                        <Border Stroke="#E5E7EB"
                                                StrokeThickness="1"
                                                StrokeShape="RoundRectangle 12"
                                                BackgroundColor="Transparent"
                                                Padding="16">
                                                <VerticalStackLayout Spacing="8">
                                                        <Label Text="{Binding CustomerLabelText}"
                                                               FontSize="14"
                                                               FontAttributes="Bold"
                                                               TextColor="{Binding TextColor}"/>
                                                        <Label Text="{Binding CustomerSummary}"
                                                               FontSize="16"
                                                               TextColor="{Binding TextColor}"/>
                                                </VerticalStackLayout>
                                        </Border>

                                        <!-- Payment Method Selection (before selecting method) -->
                                        <VerticalStackLayout Spacing="20"
                                                             IsVisible="{Binding IsMethodSelected, Converter={StaticResource InvertBooleanConverter}}">

                                                <Label Text="{Binding SelectMethodLabel}"
                                                       FontSize="20"
                                                       FontAttributes="Bold"
                                                       TextColor="{Binding TextColor}"/>

                                                <Grid ColumnDefinitions="*, 16, *, 16, *"
                                                      ColumnSpacing="0"
                                                      VerticalOptions="Start">

                                                        <!-- Cash -->
                                                        <Border Grid.Column="0"
                                                                Stroke="#10B981"
                                                                StrokeThickness="2"
                                                                StrokeShape="RoundRectangle 16"
                                                                BackgroundColor="#D1FAE5"
                                                                HeightRequest="160">
                                                                <VerticalStackLayout HorizontalOptions="Center"
                                                                                     VerticalOptions="Center"
                                                                                     Spacing="16">

                                                                        <Label Text="ðŸ’µ"
                                                                               FontSize="40"
                                                                               VerticalTextAlignment="Center"
                                                                               HorizontalTextAlignment="Center"/>

                                                                        <Label Text="{Binding CashLabel}"
                                                                               FontSize="16"
                                                                               VerticalTextAlignment="Center"
                                                                               HorizontalTextAlignment="Center"
                                                                               FontAttributes="Bold"
                                                                               TextColor="#10B981"/>

                                                                </VerticalStackLayout>

                                                                <Border.GestureRecognizers>
                                                                        <TapGestureRecognizer Command="{Binding SelectPaymentMethodCommand}"
                                                                                              CommandParameter="Cash"/>
                                                                </Border.GestureRecognizers>
                                                        </Border>

                                                        <!-- Spacer -->
                                                        <BoxView Grid.Column="1"
                                                                 WidthRequest="0"/>

                                                        <!-- Mobile Money -->
                                                        <Border Grid.Column="2"
                                                                Stroke="#3B82F6"
                                                                StrokeThickness="2"
                                                                StrokeShape="RoundRectangle 16"
                                                                BackgroundColor="#DBEAFE"
                                                                HeightRequest="160">
                                                                <VerticalStackLayout HorizontalOptions="Center"
                                                                                     VerticalOptions="Center"
                                                                                     Spacing="16">

                                                                        <Label Text="ðŸ“±"
                                                                               FontSize="40"
                                                                               VerticalTextAlignment="Center"
                                                                               HorizontalTextAlignment="Center"/>

                                                                        <Label Text="{Binding MoMoLabel}"
                                                                               FontSize="16"
                                                                               FontAttributes="Bold"
                                                                               VerticalTextAlignment="Center"
                                                                               HorizontalTextAlignment="Center"
                                                                               TextColor="#3B82F6"/>

                                                                </VerticalStackLayout>

                                                                <Border.GestureRecognizers>
                                                                        <TapGestureRecognizer Command="{Binding SelectPaymentMethodCommand}"
                                                                                              CommandParameter="MoMo"/>
                                                                </Border.GestureRecognizers>
                                                        </Border>

                                                        <!-- Spacer -->
                                                        <BoxView Grid.Column="3"
                                                                 WidthRequest="0"/>

                                                        <!-- Card -->
                                                        <Border Grid.Column="4"
                                                                Stroke="#F59E0B"
                                                                StrokeThickness="2"
                                                                StrokeShape="RoundRectangle 16"
                                                                BackgroundColor="#FEF3C7"
                                                                HeightRequest="160">
                                                                <VerticalStackLayout HorizontalOptions="Center"
                                                                                     VerticalOptions="Center"
                                                                                     Spacing="16">

                                                                        <Label Text="ðŸ’³"
                                                                               FontSize="40"
                                                                               VerticalTextAlignment="Center"
                                                                               HorizontalTextAlignment="Center"/>

                                                                        <Label Text="{Binding CardLabel}"
                                                                               FontSize="16"
                                                                               FontAttributes="Bold"
                                                                               VerticalTextAlignment="Center"
                                                                               HorizontalTextAlignment="Center"
                                                                               TextColor="#F59E0B"/>

                                                                </VerticalStackLayout>

                                                                <Border.GestureRecognizers>
                                                                        <TapGestureRecognizer Command="{Binding SelectPaymentMethodCommand}"
                                                                                              CommandParameter="Card"/>
                                                                </Border.GestureRecognizers>
                                                        </Border>
                                                </Grid>
                                        </VerticalStackLayout>

                                        <!-- Selected Method Content (after selecting method) -->
                                        <VerticalStackLayout Spacing="20"
                                                             IsVisible="{Binding IsMethodSelected}">

                                                <!-- Selected Method Header -->
                                                <Border BackgroundColor="{Binding SelectedMethodColor}"
                                                        Stroke="{Binding SelectedMethodColor}"
                                                        StrokeThickness="2"
                                                        StrokeShape="RoundRectangle 12"
                                                        Padding="24,16">
                                                        <HorizontalStackLayout Spacing="16"
                                                                               HorizontalOptions="Center">
                                                                <Label Text="{Binding SelectedMethodIcon}"
                                                                       FontSize="32"
                                                                       VerticalOptions="Center"/>

                                                                <VerticalStackLayout Spacing="4">
                                                                        <Label Text="{Binding SelectedMethodLabel}"
                                                                               FontSize="14"
                                                                               TextColor="{Binding TextColor}"/>
                                                                        <Label Text="{Binding SelectedMethodDisplay}"
                                                                               FontSize="18"
                                                                               FontAttributes="Bold"
                                                                               TextColor="{Binding SelectedMethodColor}"/>
                                                                </VerticalStackLayout>

                                                                <!-- Change Method Button -->
                                                                <Button Text="{Binding ChangeMethodLabel}"
                                                                        BackgroundColor="Transparent"
                                                                        TextColor="White"
                                                                        FontSize="14"
                                                                        HeightRequest="36"
                                                                        Command="{Binding ClearSelectionCommand}"
                                                                        Margin="24,0,0,0"/>
                                                        </HorizontalStackLayout>
                                                </Border>

                                                <!-- Method-Specific Content -->

                                        </VerticalStackLayout>
                                </VerticalStackLayout>

                                <!-- Action Buttons - Only shown when payment method is selected -->
                                <Grid Grid.Row="3"
                                      ColumnDefinitions="*, 12, *"
                                      ColumnSpacing="0"
                                      IsVisible="{Binding IsMethodSelected}">

                                        <!-- Cancel/Back to Methods Button -->
                                        <Button Grid.Column="0"
                                                Text="{Binding BackToMethodsLabel}"
                                                BackgroundColor="Transparent"
                                                TextColor="#6B7280"
                                                FontSize="14"
                                                HeightRequest="48"
                                                Command="{Binding ClearSelectionCommand}"/>

                                        <!-- Spacer -->
                                        <BoxView Grid.Column="1"
                                                 WidthRequest="0"/>

                                        <!-- Process Payment Button -->
                                        <Button Grid.Column="2"
                                                Text="{Binding ProcessButtonText}"
                                                BackgroundColor="#10B981"
                                                TextColor="White"
                                                Command="{Binding ProcessPaymentCommand}"
                                                IsEnabled="{Binding CanCompletePayment}"/>

                                </Grid>

                        </Grid>

                </Border>
        </ScrollView>

</ContentView>