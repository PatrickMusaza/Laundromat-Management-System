<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:LaundromatManagementSystem.ViewModels"
             xmlns:models="clr-namespace:LaundromatManagementSystem.Models"
             x:Class="LaundromatManagementSystem.Views.ShoppingCart"
             x:Name="ShoppingCartView">

    <Border Stroke="{Binding CartBorderColor}"
            StrokeThickness="1"
            StrokeShape="RoundRectangle 12,12,12,12"
            BackgroundColor="{Binding CartBackgroundColor}"
            Padding="16">

        <Grid RowDefinitions="Auto, *, Auto, Auto">

            <!-- Header -->
            <VerticalStackLayout Grid.Row="0"
                                 Padding="0,0,12,0">

                <Grid ColumnDefinitions="Auto,Auto,*,Auto"
                      VerticalOptions="Center"
                      ColumnSpacing="8">

                    <Label Grid.Column="0"
                           Text="ðŸ›’"
                           FontSize="24"/>
                    <Label Grid.Column="1"
                           Text="{Binding CartTitle}"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="{Binding CartTitleColor}"/>

                    <!-- Spacer -->
                    <BoxView Grid.Column="2"
                             HeightRequest="0"/>

                    <!-- Cart Count Badge -->
                    <Border Grid.Column="3"
                            IsVisible="{Binding Cart.Count, Converter={StaticResource GreaterThanZeroConverter}}"
                            BackgroundColor="#F59E0B"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 100,100,100,100"
                            WidthRequest="24"
                            HeightRequest="24"
                            VerticalOptions="Center">
                        <Label Text="{Binding Cart.Count}"
                               FontSize="12"
                               FontAttributes="Bold"
                               TextColor="White"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>
                    </Border>

                </Grid>

                <BoxView Color="{Binding CartBorderColor}"
                         HeightRequest="1"
                         HorizontalOptions="Fill"
                         Margin="0,10,0,0"/>

            </VerticalStackLayout>

            <!-- Cart Items -->
            <CollectionView Grid.Row="1"
                            ItemsSource="{Binding Cart}"
                            SelectionMode="None"
                            VerticalScrollBarVisibility="Always"
                            EmptyView="{Binding EmptyView}">

                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical"
                                       ItemSpacing="2"/>
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <!-- REMOVED x:DataType -->
                        <Border Stroke="{Binding Path=BindingContext.ItemBorderColor, Source={x:Reference ShoppingCartView}}"
                                StrokeThickness="1"
                                StrokeShape="RoundRectangle 8"
                                BackgroundColor="{Binding Path=BindingContext.ItemBackgroundColor, Source={x:Reference ShoppingCartView}}"
                                Padding="12">

                            <Grid RowDefinitions="1*, 1*, 1*"
                                  ColumnDefinitions="*, Auto">

                                <!-- Item Name and Price -->
                                <VerticalStackLayout Grid.Row="0"
                                                     Grid.Column="0"
                                                     Grid.RowSpan="3">
                                    <Label Text="{Binding Name}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{Binding Path=BindingContext.ItemTextColor, Source={x:Reference ShoppingCartView}}"/>
                                    <Label Text="{Binding Price, StringFormat='{0:N0} RWF'}"
                                           FontSize="12"
                                           TextColor="#F59E0B"
                                           Margin="0,4,0,0"/>

                                    <!-- Addons -->
                                    <VerticalStackLayout IsVisible="{Binding Addons.Count, Converter={StaticResource GreaterThanZeroConverter}}"
                                                         Margin="12,8,0,0"
                                                         Spacing="4">
                                        <BoxView HeightRequest="1"
                                                 BackgroundColor="#F59E0B"
                                                 HorizontalOptions="Start"
                                                 WidthRequest="24"/>

                                        <CollectionView ItemsSource="{Binding Addons}"
                                                        SelectionMode="None"
                                                        VerticalScrollBarVisibility="Never">
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Label Text="{Binding Name, StringFormat='+ {0}'}"
                                                           FontSize="11"
                                                           TextColor="{Binding Path=BindingContext.ItemTextColor, Source={x:Reference ShoppingCartView}}"/>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>
                                    </VerticalStackLayout>

                                    <!-- Quantity Controls -->
                                    <Grid Grid.Row="1"
                                          Grid.Column="0"
                                          ColumnDefinitions="Auto, Auto, Auto"
                                          ColumnSpacing="8"
                                          VerticalOptions="Center"
                                          Margin="0,8,0,0">

                                        <Border BackgroundColor="{Binding Path=BindingContext.QuantityButtonBackground, Source={x:Reference ShoppingCartView}}"
                                                StrokeThickness="0"
                                                StrokeShape="RoundRectangle 4,4,4,4"
                                                WidthRequest="28"
                                                HeightRequest="28">
                                            <Label Text="-"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="{Binding Path=BindingContext.QuantityButtonTextColor, Source={x:Reference ShoppingCartView}}"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"/>

                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer>
                                                    <TapGestureRecognizer.Command>
                                                        <Binding Path="BindingContext.UpdateQuantityCommand"
                                                                 Source="{x:Reference ShoppingCartView}"/>
                                                    </TapGestureRecognizer.Command>
                                                    <TapGestureRecognizer.CommandParameter>
                                                        <Binding Path="."
                                                                 Converter="{StaticResource DecreaseQuantityConverter}"/>
                                                    </TapGestureRecognizer.CommandParameter>
                                                </TapGestureRecognizer>
                                            </Border.GestureRecognizers>
                                        </Border>

                                        <Label Grid.Column="1"
                                               Text="{Binding Quantity}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{Binding Path=BindingContext.ItemTextColor, Source={x:Reference ShoppingCartView}}"
                                               WidthRequest="30"
                                               HorizontalTextAlignment="Center"
                                               VerticalOptions="Center"/>

                                        <Border Grid.Column="2"
                                                BackgroundColor="{Binding Path=BindingContext.QuantityButtonBackground, Source={x:Reference ShoppingCartView}}"
                                                StrokeThickness="0"
                                                StrokeShape="RoundRectangle 4,4,4,4"
                                                WidthRequest="28"
                                                HeightRequest="28">
                                            <Label Text="+"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="{Binding Path=BindingContext.QuantityButtonTextColor, Source={x:Reference ShoppingCartView}}"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"/>

                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer>
                                                    <TapGestureRecognizer.Command>
                                                        <Binding Path="BindingContext.UpdateQuantityCommand"
                                                                 Source="{x:Reference ShoppingCartView}"/>
                                                    </TapGestureRecognizer.Command>
                                                    <TapGestureRecognizer.CommandParameter>
                                                        <Binding Path="."
                                                                 Converter="{StaticResource IncreaseQuantityConverter}"/>
                                                    </TapGestureRecognizer.CommandParameter>
                                                </TapGestureRecognizer>
                                            </Border.GestureRecognizers>
                                        </Border>
                                    </Grid>
                                </VerticalStackLayout>

                                <!-- Remove Button -->
                                <Border Grid.Row="0"
                                        Grid.Column="1"
                                        BackgroundColor="#EF4444"
                                        StrokeThickness="0"
                                        StrokeShape="RoundRectangle 4,4,4,4"
                                        HorizontalOptions="End"
                                        WidthRequest="26"
                                        HeightRequest="26">
                                    <Label Text="Ã—"
                                           FontSize="18"
                                           FontAttributes="Bold"
                                           TextColor="White"
                                           HorizontalOptions="Center"/>

                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer>
                                            <TapGestureRecognizer.Command>
                                                <Binding Path="BindingContext.RemoveItemCommand"
                                                         Source="{x:Reference ShoppingCartView}"/>
                                            </TapGestureRecognizer.Command>
                                            <TapGestureRecognizer.CommandParameter>
                                                <Binding Path="Id"/>
                                            </TapGestureRecognizer.CommandParameter>
                                        </TapGestureRecognizer>
                                    </Border.GestureRecognizers>
                                </Border>

                                <!-- Item Total -->
                                <Label Grid.Row="2"
                                       Grid.Column="1"
                                       Text="{Binding TotalPrice, StringFormat='{0:N0} RWF'}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="{Binding Path=BindingContext.ItemTextColor, Source={x:Reference ShoppingCartView}}"
                                       HorizontalOptions="End"/>

                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Empty Cart View -->
            <ContentView Grid.Row="1"
                         x:Name="EmptyCartView"
                         IsVisible="{Binding Cart.Count, Converter={StaticResource EqualToZeroConverter}}">
                <VerticalStackLayout HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Spacing="16">
                    <Label Text="ðŸ›’"
                           FontSize="48"
                           HorizontalOptions="Center"/>
                    <Label Text="{Binding EmptyCartText}"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{Binding EmptyTextColor}"
                           HorizontalOptions="Center"/>
                    <Label Text="{Binding EmptyMessageText}"
                           FontSize="14"
                           TextColor="{Binding EmptyMessageColor}"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </ContentView>

            <!-- Totals Section -->
            <Border Grid.Row="2"
                    Stroke="{Binding TotalBorderColor}"
                    StrokeThickness="1"
                    StrokeShape="RoundRectangle 8,8,8,8"
                    BackgroundColor="{Binding TotalBackgroundColor}"
                    Padding="16"
                    Margin="0,16,0,16"
                    IsVisible="{Binding Cart.Count, Converter={StaticResource GreaterThanZeroConverter}}">

                <VerticalStackLayout Spacing="8">

                    <Grid ColumnDefinitions="*, Auto">
                        <Label Grid.Column="0"
                               Text="{Binding SubtotalText}"
                               FontSize="14"
                               TextColor="{Binding ItemTextColor}"/>
                        <Label Grid.Column="1"
                               Text="{Binding Subtotal, StringFormat='{0:N0} RWF'}"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{Binding ItemTextColor}"/>
                    </Grid>

                    <Grid ColumnDefinitions="*, Auto">
                        <Label Grid.Column="0"
                               Text="{Binding TaxText}"
                               FontSize="14"
                               TextColor="{Binding ItemTextColor}"/>
                        <Label Grid.Column="1"
                               Text="{Binding Tax, StringFormat='{0:N0} RWF'}"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{Binding ItemTextColor}"/>
                    </Grid>

                    <BoxView HeightRequest="1"
                             BackgroundColor="{Binding TotalBorderColor}"
                             Margin="0,8"/>

                    <Grid ColumnDefinitions="*, Auto">
                        <Label Grid.Column="0"
                               Text="{Binding TotalText}"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{Binding CartTitleColor}"/>
                        <Label Grid.Column="1"
                               Text="{Binding Total, StringFormat='{0:N0} RWF'}"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{Binding CartTitleColor}"/>
                    </Grid>

                </VerticalStackLayout>

            </Border>

            <!-- Process Payment Button -->
            <Button Grid.Row="3"
                    Text="{Binding ProcessPaymentText}"
                    BackgroundColor="#F59E0B"
                    TextColor="White"
                    FontSize="16"
                    FontAttributes="Bold"
                    HeightRequest="64"
                    CornerRadius="8"
                    Command="{Binding ProcessPaymentCommand}"
                    IsVisible="{Binding Cart.Count, Converter={StaticResource GreaterThanZeroConverter}}"/>

        </Grid>

    </Border>

</ContentView>